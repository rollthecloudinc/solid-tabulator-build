import { a as re } from "@nf-internal/chunk-3FGMCB2V";
import { a as q } from "@nf-internal/chunk-VJMH5IEE";
import { g as P, i as A } from "@nf-internal/chunk-VZR6KEPQ";
import { H as x, f as F, l as w, m as k, z as h } from "@nf-internal/chunk-STIBVO4O";
import { a as y, b as D, f as ie } from "@nf-internal/chunk-FJYW2LMB";
import { CommonModule as ne } from "@angular/common";
import * as r from "@angular/core";
import { forwardRef as Q } from "@angular/core";
import * as m from "@angular/forms";
import { NG_VALUE_ACCESSOR as oe, NG_VALIDATORS as ae, ReactiveFormsModule as se, FormsModule as pe } from "@angular/forms";
import * as J from "@rollthecloudinc/context";
import { ContextModule as ue } from "@rollthecloudinc/context";
import * as N from "@rollthecloudinc/dparam";
import { Param as C, DparamModule as ce } from "@rollthecloudinc/dparam";
import { MaterialModule as le } from "@rollthecloudinc/material";
var V = ie(re(), 1);
import { map as d, tap as b, filter as R, delay as T, debounceTime as H, switchMap as S, take as G, defaultIfEmpty as de } from "rxjs/operators";
import * as W from "@rollthecloudinc/plugin";
import { Plugin as me, BasePluginManager as fe, PluginDef as he } from "@rollthecloudinc/plugin";
import * as O from "@rollthecloudinc/attributes";
import * as j from "@angular/material/input";
import * as _ from "@rollthecloudinc/datasource";
import { DatasourcePlugin as ge, DatasourceEditorOptions as ye, Dataset as z } from "@rollthecloudinc/datasource";
import * as K from "@rollthecloudinc/refinery";
import { DataductPlugin as ve, DuctdataOutput as B } from "@rollthecloudinc/refinery";
import * as X from "@rollthecloudinc/utils";
import * as Y from "json-rules-engine";
import * as I from "recursive-diff";
import * as Z from "@rollthecloudinc/durl";
var L = class extends me {
    constructor(a) { super(a), a && (this.create = a.create, this.read = a.read, this.update = a.update, this.delete = a.delete, a.query && (this.query = a.query)); }
}, $ = class {
    constructor(a) { this.options = [], this.params = [], a && (this.adaptorName = a.adaptorName, this.optionsString = a.optionsString ? a.optionsString : void 0, this.paramsString = a.paramsString ? a.paramsString : void 0, a.options && Array.isArray(a.options) && (this.options = a.options.map(i => new C(i))), a.params && Array.isArray(a.params) && (this.params = a.params.map(i => new C(i)))); }
}, Se = (() => { class p {
    set settings(i) { this.settings$.next(i); }
    constructor(i, t) { this.fb = i, this.attributeSerializer = t, this.contexts = [], this.settings$ = new w(void 0), this.datasource$ = new w(void 0), this.optionValues$ = new w([]), this.paramValues$ = new w([]), this.formGroup = this.fb.group({ adaptorName: this.fb.control(""), optionsString: this.fb.control(""), paramsString: this.fb.control(""), options: this.fb.control([]), params: this.fb.control([]) }), this.settingsSub = this.settings$.pipe(d(e => e ? new $(this.attributeSerializer.deserializeAsObject(e)) : void 0), b(e => setTimeout(() => this.datasource$.next(e)))).subscribe(e => { e ? (this.formGroup.get("adaptorName").setValue(e.adaptorName), this.formGroup.get("optionsString").setValue(e.optionsString ? e.optionsString : ""), this.formGroup.get("paramsString").setValue(e.paramsString ? e.paramsString : "")) : (this.formGroup.get("adaptorName").setValue(""), this.formGroup.get("optionsString").setValue(""), this.formGroup.get("paramsString").setValue(""), setTimeout(() => this.optionValues$.next([]), 2), setTimeout(() => this.optionValues$.next([]), 2)); }), this.datasourceOptionsSub = x([this.datasource$, this.formGroup.get("optionsString").valueChanges]).pipe(R(([e]) => e !== void 0), T(1), b(([e]) => this.optionValues$.next(e.options))).subscribe(), this.datasourceParamsSub = x([this.datasource$, this.formGroup.get("paramsString").valueChanges]).pipe(R(([e]) => e !== void 0), T(1), b(([e]) => this.paramValues$.next(e.params))).subscribe(), this.optionsStringChangeSub = this.formGroup.get("optionsString").valueChanges.pipe(H(500)).subscribe(e => { let l = V.default.parse("?" + e); this.optionsParsed = l; }), this.paramsStringChangeSub = this.formGroup.get("paramsString").valueChanges.pipe(H(500)).subscribe(e => { let l = V.default.parse("?" + e); this.paramsParsed = l; }), this.onTouched = () => { }; }
    ngOnInit() { }
    writeValue(i) { i && this.formGroup.setValue(i, { emitEvent: !1 }); }
    registerOnChange(i) { this.formGroup.valueChanges.subscribe(i); }
    registerOnTouched(i) { this.onTouched = i; }
    setDisabledState(i) { i ? this.formGroup.disable() : this.formGroup.enable(); }
    validate(i) { return this.formGroup.valid ? null : this.formGroup.errors; }
    static { this.\u0275fac = function (t) { return new (t || p)(r.\u0275\u0275directiveInject(m.UntypedFormBuilder), r.\u0275\u0275directiveInject(O.AttributeSerializerService)); }; }
    static { this.\u0275cmp = r.\u0275\u0275defineComponent({ type: p, selectors: [["classifieds-ui-crud-adaptor-datasource-form"]], inputs: { contexts: "contexts", settings: "settings" }, standalone: !1, features: [r.\u0275\u0275ProvidersFeature([{ provide: oe, useExisting: Q(() => p), multi: !0 }, { provide: ae, useExisting: Q(() => p), multi: !0 }])], decls: 14, vars: 7, consts: [[3, "formGroup"], ["matInput", "", "placeholder", "Adaptor", "formControlName", "adaptorName", "required", ""], [1, "options-container"], ["matInput", "", "placeholder", "Options", "formControlName", "optionsString"], ["formControlName", "options", 3, "params", "paramValues", "contexts"], [1, "params-container"], ["matInput", "", "placeholder", "Params", "formControlName", "paramsString"], ["formControlName", "params", 3, "params", "paramValues", "contexts"]], template: function (t, e) { t & 1 && (r.\u0275\u0275elementStart(0, "div", 0)(1, "div")(2, "mat-form-field"), r.\u0275\u0275element(3, "input", 1), r.\u0275\u0275elementEnd()(), r.\u0275\u0275elementStart(4, "div", 2)(5, "div")(6, "mat-form-field"), r.\u0275\u0275element(7, "input", 3), r.\u0275\u0275elementEnd()(), r.\u0275\u0275element(8, "classifieds-ui-params-form", 4), r.\u0275\u0275elementEnd(), r.\u0275\u0275elementStart(9, "div", 5)(10, "div")(11, "mat-form-field"), r.\u0275\u0275element(12, "input", 6), r.\u0275\u0275elementEnd()(), r.\u0275\u0275element(13, "classifieds-ui-params-form", 7), r.\u0275\u0275elementEnd()()), t & 2 && (r.\u0275\u0275property("formGroup", e.formGroup), r.\u0275\u0275advance(8), r.\u0275\u0275property("params", e.optionsParsed)("paramValues", e.optionValues$.value)("contexts", e.contexts), r.\u0275\u0275advance(5), r.\u0275\u0275property("params", e.paramsParsed)("paramValues", e.paramValues$.value)("contexts", e.contexts)); }, dependencies: [m.DefaultValueAccessor, m.NgControlStatus, m.NgControlStatusGroup, m.RequiredValidator, m.FormGroupDirective, m.FormControlName, j.MatInput, j.MatFormField, N.ParamsFormComponent], encapsulation: 2 }); }
} return p; })(), ee = (() => { class p {
    constructor(i) { this.controlContainer = i, this.settings = [], this.contexts = []; }
    static { this.\u0275fac = function (t) { return new (t || p)(r.\u0275\u0275directiveInject(m.ControlContainer)); }; }
    static { this.\u0275cmp = r.\u0275\u0275defineComponent({ type: p, selectors: [["classifieds-ui-crud-adaptor-datasource"]], inputs: { settings: "settings", contexts: "contexts" }, standalone: !1, decls: 2, vars: 3, consts: [[3, "formGroup"], ["formControlName", "settings", 3, "settings", "contexts"]], template: function (t, e) { t & 1 && (r.\u0275\u0275elementContainerStart(0, 0), r.\u0275\u0275element(1, "classifieds-ui-crud-adaptor-datasource-form", 1), r.\u0275\u0275elementContainerEnd()), t & 2 && (r.\u0275\u0275property("formGroup", e.controlContainer.control), r.\u0275\u0275advance(), r.\u0275\u0275property("settings", e.settings)("contexts", e.contexts)); }, dependencies: [m.NgControlStatus, m.NgControlStatusGroup, m.FormGroupDirective, m.FormControlName, Se], encapsulation: 2 }); }
} return p; })(), Ce = (p, a, i, t, e, l) => new ge({ id: "crud_adaptor", title: "Crud Adaptor", editor: ee, fetch: ({ settings: g, metadata: v }) => h(new z).pipe(d(() => a.deserializeAsObject(g)), d(n => new $(n)), S(n => i.getPlugin(n.adaptorName).pipe(d(s => ({ plugin: s, ds: n })))), d(({ plugin: n, ds: s }) => ({ plugin: n, ds: s, optionNames: s.optionsString ? s.optionsString.split("&").filter(o => o.indexOf("=:") !== -1).map(o => o.split("=", 2)[1].substr(1)) : [] })), S(({ plugin: n, ds: s, optionNames: o }) => P([t.paramValues(s.options.reduce((u, c, f) => new Map([...u, [o[f], c]]), new Map)).pipe(d(u => Array.from(u).reduce((c, [f, M]) => D(y({}, c), { [f]: M }), {}))), s.paramsString && s.paramsString !== "" ? l.getUrl("?" + s.paramsString, s.params, v).pipe(G(1)) : h(void 0)]).pipe(d(([u, c]) => ({ plugin: n, options: u, query: c })))), S(({ plugin: n, options: s, query: o }) => e.evaluateCollectionPlugins({ plugins: { [n.id]: { params: s } }, op: "query", query: o && o.substr(1) })), d(n => new z({ results: n }))), editorOptions: () => h(new ye({ fullscreen: !0 })), getBindings: ({ settings: g, metadata: v }) => h([]) }), be = ({ crudDataHelper: p, attributeSerializer: a }) => new ve({ id: "crud", title: "Crud", editor: ee, send: i => h(new B({})).pipe(d(() => ({ settings: a.deserializeAsObject(i.settings) })), b(({ settings: t }) => console.log("crud data duct", t)), d(({ settings: t }) => ({ plugins: { [`${t.adaptorName}`]: { plugin: `${t.adaptorName}`, ops: ["create"], params: `${t.optionsString}`.split("&").reduce((e, l, g) => D(y({}, e), { [l.split("=", 1)[0]]: new C(t.options[g]) }), {}) } } })), S(({ plugins: t }) => p.evaluatePlugins({ object: i.data, plugins: t, op: "create", parentObject: { id: q() } })), d(() => new B({}))) }), te = (() => { class p extends fe {
    constructor(i, t) { super(i, t); }
    pluginDef() { return h(new he({ name: "crud_adaptor" })); }
    static { this.\u0275fac = function (t) { return new (t || p)(r.\u0275\u0275inject(W.PluginConfigurationManager), r.\u0275\u0275inject(X.ModuleLoaderService)); }; }
    static { this.\u0275prov = r.\u0275\u0275defineInjectable({ token: p, factory: p.\u0275fac, providedIn: "root" }); }
} return p; })(), De = (() => { class p {
    constructor(i) { this.crud = i, this.cachedCollectionQueries = [], this.cachedCollectionIgnore = { p: { create: void 0, update: void 0, delete: void 0, query: void 0, read: void 0 }, input: { identity: void 0 } }; }
    evaluatePlugins({ object: i, plugins: t, op: e, parentObject: l }) { let v = Object.keys(t).filter(n => !t[n].ops || t[n].ops.includes(e)).map(n => this.crud.getPlugin(t[n].plugin ? t[n].plugin : n).pipe(d(s => ({ p: s, params: t[n].params ? Object.keys(t[n].params).reduce((o, u) => D(y({}, o), { [u]: t[n].params[u] instanceof C ? t[n].params[u] : new C({ flags: [], mapping: { type: "static", value: t[n].params[u], context: void 0, testValue: t[n].params[u] } }) }), {}) : {} })), S(({ p: s, params: o }) => s[e]({ rule: void 0, object: i, parentObject: l, params: o, identity: ({ object: u, parentObject: c }) => h({ identity: u.id ? u.id : c ? c.id : void 0 }) })), S(s => A(() => t[n].plugins && Object.keys(t[n].plugins).length !== 0, t[n].plugins && Object.keys(t[n].plugins).length !== 0 ? this.evaluatePlugins({ plugins: t[n].plugins, object: s.entity ? s.entity : i, parentObject: s.originalEntity ? s.originalEntity : i, op: e }) : h(s), h(s))))); return P(v).pipe(d(() => i)); }
    evaluateCollectionPlugins({ query: i, objects: t, plugins: e, op: l, parentObjects: g }) { console.log("evaluate collection plugins"); let v = Object.keys(e), n = v.filter(o => !e[o].ops || e[o].ops.includes(l)).map(o => this.crud.getPlugin(e[o].plugin ? e[o].plugin : o).pipe(d(u => ({ p: u, params: e[o].params ? Object.keys(e[o].params).reduce((c, f) => D(y({}, c), { [f]: e[o].params[f] instanceof C ? e[o].params[f] : new C({ flags: [], mapping: { type: "static", value: e[o].params[f], context: void 0, testValue: e[o].params[f] } }) }), {}) : {} })), S(({ p: u, params: c }) => this.buildQueryRule({ params: i, config: e[o] }).pipe(d(({ rule: f }) => ({ p: u, params: c, rule: f })))), S(({ p: u, params: c, rule: f }) => this.flightAndCacheAwareCollectionQuery({ p: u, input: { rule: f, objects: t, parentObjects: g, params: c, identity: ({ object: M, parentObject: E }) => h({ identity: M.id ? M.id : E ? E.id : void 0 }) } }).pipe(b(() => console.log("end of crud query call")))), S(u => A(() => e[o].plugins && Object.keys(e[o].plugins).length !== 0, this.evaluateCollectionPlugins({ query: i, plugins: e[o].plugins && Object.keys(e[o].plugins).length !== 0 ? e[o].plugins : {}, objects: u.entities ? u.entities : t, parentObjects: u.originalEntities ? u.originalEntities : t, op: l }), h(u))), b(u => console.log("end of op", u)))); return v.filter(o => !e[o].ops || e[o].ops.includes(l)).find(o => e[o].fallback) && n.length > 1 ? n.reduce((o, u) => o.pipe(S(c => c && Array.isArray(c) && c.length > 0 ? h(c) : u.pipe(d(f => f && f.entities && Array.isArray(f.entities) ? f.entities : []))), S(c => c.length > 0 ? h(c) : h([]))), h([])) : n.length === 1 ? n[0].pipe(d(o => [...o.entities])) : P(n).pipe(d(o => o.reduce((u, c) => [...u, ...c.entities], [])), de([])); }
    buildQueryRule({ params: i, config: t }) { return new F(e => { let l = []; typeof i == "string" && i.split("&").map(n => n.split("=", 2)).reduce((n, [s, o]) => new Map([...Array.from(n).filter(([u, c]) => u !== s), [s, [...n.has(s) ? n.get(s) : [], o]]]), new Map).forEach((n, s) => l.push({ any: n.map(o => y({ fact: s === "identity" ? "identity" : "entity", operator: t.queryMappings && t.queryMappings.has(s) && t.queryMappings.get(s).defaultOperator ? t.queryMappings.get(s).defaultOperator : "equal", value: o }, s === "identity" ? {} : { path: `$.${s}` })) })); let g = l.length > 0 ? new Y.Rule({ conditions: { all: l }, event: { type: "visible" } }) : void 0; e.next({ rule: g }), e.complete(); }); }
    flightAndCacheAwareCollectionQuery(i) { let t = this.cachedCollectionQueries.findIndex(({ p: e, input: l }) => { let g = I.getDiff(y(y({}, i.p), this.cachedCollectionIgnore.p), y(y({}, e), this.cachedCollectionIgnore.p)), v = I.getDiff(y(y({}, i.input), this.cachedCollectionIgnore.input), y(y({}, l), this.cachedCollectionIgnore.input)); return g.length === 0 && v.length === 0; }); return t === -1 && (this.cachedCollectionQueries.push({ p: i.p, input: i.input, query$: new k }), t = this.cachedCollectionQueries.length - 1, i.p.query(i.input).pipe(b(e => this.cachedCollectionQueries[t].query$.next(e)), G(1)).subscribe()), this.cachedCollectionQueries[t].query$.pipe(G(1)); }
    static { this.\u0275fac = function (t) { return new (t || p)(r.\u0275\u0275inject(te)); }; }
    static { this.\u0275prov = r.\u0275\u0275defineInjectable({ token: p, factory: p.\u0275fac, providedIn: "root" }); }
} return p; })(), Qe = (() => { class p {
    constructor(i, t, e, l, g, v, n, s) { i.register(Ce(l, g, t, v, n, s)), e.register(be({ crudDataHelper: n, attributeSerializer: g })); }
    static { this.\u0275fac = function (t) { return new (t || p)(r.\u0275\u0275inject(_.DatasourcePluginManager), r.\u0275\u0275inject(te), r.\u0275\u0275inject(K.DataductPluginManager), r.\u0275\u0275inject(J.ParamContextExtractorService), r.\u0275\u0275inject(O.AttributeSerializerService), r.\u0275\u0275inject(N.ParamEvaluatorService), r.\u0275\u0275inject(De), r.\u0275\u0275inject(Z.UrlGeneratorService)); }; }
    static { this.\u0275mod = r.\u0275\u0275defineNgModule({ type: p }); }
    static { this.\u0275inj = r.\u0275\u0275defineInjector({ imports: [ne, se, pe, le, ue, ce] }); }
} return p; })(), Re = { success: !1 }, U = class {
    get name() { return this._name; }
    constructor(a, i, t, e) { this.crud = i, this.entityDefinitionService = t, this.crudDataHelperService = e, this._name = `${a} CrudDataService`, this.entityName = a; }
    add(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluatePlugins({ object: a, plugins: i.crud, op: "create" }); }
    update(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluatePlugins({ object: a.changes, plugins: i.crud, op: "update" }); }
    upsert(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluatePlugins({ object: a, plugins: i.crud, op: "update" }); }
    delete(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.getById(a).pipe(S(t => this.crudDataHelperService.evaluatePlugins({ object: t, plugins: i.crud, op: "delete" })), d(() => a)); }
    getAll() { let a = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluateCollectionPlugins({ plugins: a.crud, op: "query" }); }
    getById(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluateCollectionPlugins({ query: `identity=${a}`, plugins: i.crud, op: "query" }).pipe(d(t => t && t.length !== 0 ? t[0] : void 0)); }
    getWithQuery(a) { let i = this.entityDefinitionService.getDefinition(this.entityName).metadata; return this.crudDataHelperService.evaluateCollectionPlugins({ query: a, plugins: i.crud, op: "query" }); }
};
export { $ as CrudAdaptorDatasource, ee as CrudAdaptorDatasourceComponent, Se as CrudAdaptorDatasourceFormComponent, L as CrudAdaptorPlugin, te as CrudAdaptorPluginManager, De as CrudDataHelperService, U as CrudDataService, Qe as CrudModule, Re as blankCrudAdaptorResponse };
